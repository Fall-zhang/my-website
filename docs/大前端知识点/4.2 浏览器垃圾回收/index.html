<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-大前端知识点/4.2 浏览器垃圾回收">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/my-website/blog/rss.xml" title="Fall 的笔记本 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/my-website/blog/atom.xml" title="Fall 的笔记本 Atom Feed"><title data-rh="true">4.2 浏览器垃圾回收 | Fall 的笔记本</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://fall-zhang.github.io/my-website/docs/大前端知识点/4.2 浏览器垃圾回收"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="4.2 浏览器垃圾回收 | Fall 的笔记本"><meta data-rh="true" name="description" content="Create by fall on 2021-09-16"><meta data-rh="true" property="og:description" content="Create by fall on 2021-09-16"><link data-rh="true" rel="icon" href="/my-website/./img/favicon.ico"><link data-rh="true" rel="canonical" href="https://fall-zhang.github.io/my-website/docs/大前端知识点/4.2 浏览器垃圾回收"><link data-rh="true" rel="alternate" href="https://fall-zhang.github.io/my-website/docs/大前端知识点/4.2 浏览器垃圾回收" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://fall-zhang.github.io/my-website/docs/大前端知识点/4.2 浏览器垃圾回收" hreflang="x-default"><link rel="stylesheet" href="/my-website/assets/css/styles.075a81d0.css">
<link rel="preload" href="/my-website/assets/js/runtime~main.0db5d409.js" as="script">
<link rel="preload" href="/my-website/assets/js/main.201f75f3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/my-website/"><div class="navbar__logo"><img src="/my-website/../img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/my-website/../img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Fall 的笔记本</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/my-website/docs/笔记介绍">笔记</a><a class="navbar__item navbar__link" href="/my-website/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Fall-zhang" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/my-website/docs/笔记介绍">笔记介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/my-website/docs/category/html-和-css">HTML 和 CSS</a><button aria-label="打开/收起侧边栏菜单「HTML 和 CSS」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/my-website/docs/category/javascript--typescript">JavaScript &amp; TypeScript</a><button aria-label="打开/收起侧边栏菜单「JavaScript &amp; TypeScript」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/my-website/docs/category/大前端知识点">大前端知识点</a><button aria-label="打开/收起侧边栏菜单「大前端知识点」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/-- 服务器状态码">-- 服务器状态码</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/-- JS设计模式">-- JS设计模式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/浏览器">浏览器工作原理与实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/1.1-浏览器工作原理">1.1-浏览器工作原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/1.2-网页的网络交互">1.2-网页的网络交互</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/1.3-性能指标、优化">1.3-性能指标、优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/2.1 前端的发展">2.1 前端的发展</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/2.2 前端技术演进和Serverless">2.2 前端技术演进和Serverless</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/2.3 SPA介绍">2.3 SPA介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/2.4 PWA介绍">2.4 PWA介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/2.5-Jamstack">2.5-Jamstack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/3.1 浏览器缓存机制">3.1 浏览器缓存机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/3.2 Session、Cookie、Token">3.2 Session、Cookie、Token</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/4.1 浏览器同源策略">4.1 浏览器同源策略</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/my-website/docs/大前端知识点/4.2 浏览器垃圾回收">4.2 浏览器垃圾回收</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/4.3-Node内存限制">4.3-Node内存限制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/5.1-TCP、IP协议">5.1-TCP、IP协议</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/5.2 WebSocket">5.2 WebSocket</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/6.1 HTTP协议">6.1 HTTP协议</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/6.2 HTTP协议发展">6.2 HTTP协议发展</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/6.3 HTTPS">6.3 HTTPS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/7.1 网络分层和基础">7.1 网络分层和基础</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/7.3 DNS，CDN是个啥？">7.3 DNS，CDN是个啥？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/8. 网站攻击">8. 网站攻击</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/my-website/docs/大前端知识点/9-Web3">9-Web3</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/my-website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/my-website/docs/category/大前端知识点"><span itemprop="name">大前端知识点</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">4.2 浏览器垃圾回收</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>4.2 浏览器垃圾回收</h1></header><blockquote><p>Create by <strong>fall</strong> on 2021-09-16
Recently revised in 2022-05-19</p></blockquote><p>JS 中常见的内存泄漏有四种：</p><ul><li>全局变量</li><li>闭包</li><li>DOM 元素的引用</li><li>定时器</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="垃圾回收机制">垃圾回收机制<a class="hash-link" href="#垃圾回收机制" title="标题的直接链接">​</a></h2><p>在 JavaScript 中，数据类型分为两类，简单类型（基本类型）和引用类型，对于简单类型，内存是保存在栈（stack）空间中，复杂数据类型，内存是保存在堆（heap）空间中。</p><ul><li>基本类型：这些类型在内存中分别占有固定大小的空间，他们的值保存在栈空间，我们通过按值来访问的。<ul><li>而对于栈的内存空间，只保存简单数据类型的内存，<strong>由操作系统自动分配和自动释放</strong>。</li></ul></li><li>引用类型：引用类型，值大小不固定，栈内存中存放地址指向堆内存中的对象。是按引用访问的。<ul><li>而堆空间中的内存，由于大小不固定，系统无法无法进行自动释放，这个时候就需要<strong>JS引擎来手动的释放这些内存</strong>。当代码书写错误时，会使垃圾回收机制无法正确对内存进行释放，从而使浏览器占用内存不断增加。</li></ul></li></ul><p><strong>为什么要进行垃圾回收？</strong></p><p>chrome 限制了 v8 引擎的内存使用（64 位约 1.4G/1464MB，32位约 0.7G/732MB）</p><p>有两层原因，为浏览器设置，本身不可能遇到大量使用内存的场景。并且，清理内存很耗时间，会引起线程暂停的执行时间，性能也会下降。</p><p>JS 引擎来手动的释放内存时。代码书写错误，会使垃圾回收机制无法正确对内存进行释放，从而使浏览器占用内存不断增加，JavaScript和应用、操作系统性能下降。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="垃圾回收">垃圾回收<a class="hash-link" href="#垃圾回收" title="标题的直接链接">​</a></h2><p>大多数对象存活周期都很短，经历过一次垃圾回收后，就被释放掉，为了提高内存利用效率，堆被分成了两个部分。</p><ul><li>新生代（Young Generation）：新生代中存放的是生存时间短的对象（通常为1-8M容量）<ul><li>新生代包括 Nursery 和 Intermediate</li></ul></li><li>老生代（Old Generation）：存放生存时间久的对象（支持容量会大很多）</li></ul><p>所以有两个垃圾回收器：</p><p>副垃圾回收器 - <code>Scavenge</code> 主要负责新生代的垃圾回收。</p><p>主垃圾回收器 - <code>Mark-Sweep &amp; Mark-Compact</code> 主要负责老生代的垃圾回收。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="新生代垃圾回收">新生代垃圾回收<a class="hash-link" href="#新生代垃圾回收" title="标题的直接链接">​</a></h3><p><strong>Scavenge</strong></p><p>任何对象声明分配到的内存，会先放置到新生代中，特点是存活周期很短。</p><p>分别叫 <code>from-space</code> 和 <code>to-space</code>，工作方式也很简单，就是将 <code>from-space</code> 中存活的活动对象复制到 <code>to-space</code> 中，并将这些对象的内存有序的排列起来，然后将 <code>from-space</code> 中的非活动对象的内存进行释放，完成之后，将<code>from space</code> 和 <code>to space</code> 进行互换，这样可以使得新生代中的这两块区域可以重复利用。</p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3aa64c441ac4b3c922dbeacf568486c~tplv-k3u1fbpfcp-watermark.image" alt="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3aa64c441ac4b3c922dbeacf568486c~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"><p>总结来讲，就是</p><ul><li>标记非活动对象</li><li>把非活动对象从 <code>from space</code>复制到 <code>to space</code> 进行排序</li><li>释放 <code>from space</code> 的内存</li><li>把二者角色互换</li></ul><p>如何判断是否是非活动对象呢？</p><u>对象的可达性</u>表示从初始的根对象（window，global）的指针开始（ES6 提出了 `globalThis` 同时作为 node 和 browser 的跟指针），这个根指针对象被称为根集（root set），从这个根集向下搜索其子节点，被搜索到的子节点说明该节点的引用对象可达，并为其留下标记，然后递归这个搜索的过程，直到所有子节点都被遍历结束，那么没有被标记的对象节点，说明该对象没有被任何地方引用，可以证明这是一个需要被释放内存的对象，可以被垃圾回收器回收。<p>新生代对象什么时候变成老生代对象？</p><p>在新生代中，还进一步进行了细分，分为<code>nursery</code>子代和<code>intermediate</code>子代两个区域，一个对象第一次分配内存时会被分配到新生代中的<code>nursery</code>子代，如果进过下一次垃圾回收这个对象还存在新生代中，这时候我们移动到 <code>intermediate</code> 子代，再经过下一次垃圾回收，如果这个对象还在新生代中，副垃圾回收器会将该对象移动到老生代中，这个移动的过程被称为晋升。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="老生代垃圾回收">老生代垃圾回收<a class="hash-link" href="#老生代垃圾回收" title="标题的直接链接">​</a></h3><p><strong>Mark-Sweep &amp; Mark-Compact</strong></p><p>对于老生代对象来说，如果再使用新生代的<code>scavenge</code>算法的话，会出现两个问题：</p><ul><li>重复的复制算法导致效率低下</li><li><code>scavenge</code> 是牺牲空间换取时间的算法，老生代空间大，会导致浪费大量的空间</li></ul><p>所以清除方法是：标记清除（<code>Mark-Sweep</code>），标记整理（<code>Mark-Compact</code>）</p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11fd0de1b2dc454f8c4044db7f247dd3~tplv-k3u1fbpfcp-watermark.image" alt="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11fd0de1b2dc454f8c4044db7f247dd3~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"><p>标记清除：标记了活动对象后，直接把非活动对象清除</p><ul><li>标记阶段：老生代进行第一次扫描，标记活动对象</li><li>清理阶段：对老生代进行第二次扫描，清除未被标记的对象，清理非活动对象</li></ul><p>但是回收结束后，会产生相当多的内存碎片接下来需要进行：标记整理</p><img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5794dcc43e774987a75234f4f5052434~tplv-k3u1fbpfcp-watermark.image" alt="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5794dcc43e774987a75234f4f5052434~tplv-k3u1fbpfcp-watermark.image" class="img_ev3q"><p>标记整理：如果不清理这些对象，会导致下一次分配一个大对象时，空间碎片都无法进行分配。</p><p>将所有的活动对象往一端移动，移动完成后，直接清理掉边界外的内存。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="全停顿">全停顿<a class="hash-link" href="#全停顿" title="标题的直接链接">​</a></h2><p>垃圾回收在 JS 引擎中进行的，Mark-Compact 算法需要移动对象，当活动的对象比较多，执行速度就会变慢，为了避免垃圾回收期的内存资源竞争导致的不一致的问题，会进行<strong>全停顿</strong>（stop the world）将JavaScript 应用暂停。</p><ul><li>新生代中，空间小，存放对象少，Scavenge 执行效率快，全停顿影响不大</li><li>老生代中，对象较多，垃圾回收期会暂停主线程较长时间，导致界面变得卡顿</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="优化方法">优化方法<a class="hash-link" href="#优化方法" title="标题的直接链接">​</a></h2><p>Orinoco 是垃圾回收期的项目代号</p><p>V8 为了解决全停顿的问题，利用增量标记、懒性清理、并发、并行来降低主线程的挂起时间</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="增量标记">增量标记<a class="hash-link" href="#增量标记" title="标题的直接链接">​</a></h3><p>Incremental marking</p><p>增量标记会将原本的标记全堆对象拆分为一个一个任务，让其穿插在JavaScript应用逻辑之间执行，以此来降低垃圾回收的停顿时间。</p><p>增量标记允许堆的标记时的 5-10ms 的停顿。增量标记会在堆的大小达到一定阈值时启用，启用之后，每当一定量的内存分配后脚本的执行就会停顿，并进行一次增量标记。<img loading="lazy" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9fc9b4c9f94f4683b1079cb56f4963f0~tplv-k3u1fbpfcp-watermark.image" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="懒清理">懒清理<a class="hash-link" href="#懒清理" title="标题的直接链接">​</a></h3><p>Lazy sweeping</p><p>增量标记只是对活动对象和非活动对象进行标记，惰性清理用来真正的释放内存。增量标记完成后，当可用内存足以快速执行代码时，是没有必要立即清理内存的。可以将清理的过程推迟，让 JS 逻辑代码先去执行。也无需一次性清理所有非活动对象的内存，垃圾回收期会逐一按需清理，直到所有页都清理完毕。</p><blockquote><p>增量标记和懒清理让主线成最大停顿时间减少了 80%，用户的交互变得流畅了许多，但是从实现机制上，每个增量标记之间执行了JavaScript代码，堆中对象指针可能发生变化，需要<strong>写屏障</strong>来记录这些引用关系的变化。</p><p>所以，懒清理的缺点也就显而易见</p><ul><li>并没有减少主线程的总暂停时间，甚至可能略微增加</li><li>写屏障（write-barrier）机制的成本，表计量会降低应用程序的吞吐量</li></ul></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="并发">并发<a class="hash-link" href="#并发" title="标题的直接链接">​</a></h3><p>Concurrent</p><p>并发不需要将主线程挂起，可以同时进行，只有个别时候需要短暂停下来去做一些事，两者可以同时进行，只有个别时间需要做一些特殊操作，也要面对增量回收的问题，由于JS代码在执行，引用关系也会变化，也需要写屏障</p><p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bc4f2f75764453a8fccf310299c064e~tplv-k3u1fbpfcp-watermark.image" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="并行">并行<a class="hash-link" href="#并行" title="标题的直接链接">​</a></h3><p>Parallel</p><p>允许主线程和辅助线程做相同的GC工作，可以让辅助线程来分担主线程的GC工作，使得垃圾回收所耗费的时间等于总时间除以参与的线程的数量（会有一些同步开销）</p><p><img loading="lazy" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1196a621ab2942f6a8be2f9b940e5fad~tplv-k3u1fbpfcp-watermark.image" alt="img" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="v8当前回收机制">V8当前回收机制<a class="hash-link" href="#v8当前回收机制" title="标题的直接链接">​</a></h2><p>2011年，V8应用了增量标记。2018年，Chrome64和Node.js V10 启动并发表及，同时在并发的基础上添加并行技术，使得垃圾回收时间大幅度缩短</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="副垃圾回收器">副垃圾回收器<a class="hash-link" href="#副垃圾回收器" title="标题的直接链接">​</a></h3><p>当活动对象从 from-to 复制到 <code>space-to</code> 的时候，会启用多个辅助线程，并行进行整理。多个线程竞争一个新生代的堆得内存资源，可能出现有某个活动对象被多个线程进行复制操作的问题，为了解决这个问题，V8在第一个线程对活动对象进行复制并且复制完成后，都必须去维护复制这个活动对象后的指针转发地址，以便于其他协助线程可以找到该活动对象后可以判断该活动对象是否已被复制。</p><p><img loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9bdfa09d1314b5ba9ca09e94464fd84~tplv-k3u1fbpfcp-watermark.image" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主垃圾回收器">主垃圾回收器<a class="hash-link" href="#主垃圾回收器" title="标题的直接链接">​</a></h3><p>当堆中的内存大小超过某个阈值之后，会启用并发，标记任务，每个辅助线程都会去追踪每个标记到的对象的指针以及对这个对象的引用。</p><p>在JS代码执行中，并发标记也在后台的辅助进程中进行，当某个指针对象被JS修改时，写入屏障技术会在辅助线程并发表及的时候，进行追踪。</p><p>当并发标记完成或者动态分配的内存达到极限的时候，住线程会执行最终的快速标记步骤，这个时候，主线程会挂起，进行再一次的扫描根集以确保所有的对象都完成了标记。由于辅助线程已经标记过活动对象，主线程的本次扫描只是进行check操作，确认完成之后，某些辅助线程会进行清理内存操作，某些辅助进程会进行内存整理操作，由于都是并发的，并不会影响主线程JavaScript代码的执行。</p><p>内存使用观察是否存在内存泄露，而防止内存泄露，是提升应用性能的一个重要举措。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考文章">参考文章<a class="hash-link" href="#参考文章" title="标题的直接链接">​</a></h2><table><thead><tr><th>作者</th><th>链接</th></tr></thead><tbody><tr><td>杨溜溜</td><td><a href="https://juejin.cn/post/6876638765025067015" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6876638765025067015</a></td></tr></tbody></table><table><thead><tr><th>相关文章</th><th>链接</th></tr></thead><tbody><tr><td>写入屏障</td><td><a href="https://dl.acm.org/doi/book/10.5555/2025255" target="_blank" rel="noopener noreferrer">https://dl.acm.org/doi/book/10.5555/2025255</a></td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/大前端知识点/4.2 浏览器垃圾回收.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/my-website/docs/大前端知识点/4.1 浏览器同源策略"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">4.1 浏览器同源策略</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/my-website/docs/大前端知识点/4.3-Node内存限制"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">4.3-Node内存限制</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#垃圾回收机制" class="table-of-contents__link toc-highlight">垃圾回收机制</a></li><li><a href="#垃圾回收" class="table-of-contents__link toc-highlight">垃圾回收</a><ul><li><a href="#新生代垃圾回收" class="table-of-contents__link toc-highlight">新生代垃圾回收</a></li><li><a href="#老生代垃圾回收" class="table-of-contents__link toc-highlight">老生代垃圾回收</a></li></ul></li><li><a href="#全停顿" class="table-of-contents__link toc-highlight">全停顿</a></li><li><a href="#优化方法" class="table-of-contents__link toc-highlight">优化方法</a><ul><li><a href="#增量标记" class="table-of-contents__link toc-highlight">增量标记</a></li><li><a href="#懒清理" class="table-of-contents__link toc-highlight">懒清理</a></li><li><a href="#并发" class="table-of-contents__link toc-highlight">并发</a></li><li><a href="#并行" class="table-of-contents__link toc-highlight">并行</a></li></ul></li><li><a href="#v8当前回收机制" class="table-of-contents__link toc-highlight">V8当前回收机制</a><ul><li><a href="#副垃圾回收器" class="table-of-contents__link toc-highlight">副垃圾回收器</a></li><li><a href="#主垃圾回收器" class="table-of-contents__link toc-highlight">主垃圾回收器</a></li></ul></li><li><a href="#参考文章" class="table-of-contents__link toc-highlight">参考文章</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://juejin.cn/user/1565342280463325" target="_blank" rel="noopener noreferrer" class="footer__link-item">掘金<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/Fall-zhang" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://segmentfault.com/u/fall_zhang0" target="_blank" rel="noopener noreferrer" class="footer__link-item">思否segmentfault<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">联系</div><ul class="footer__items clean-list"><li class="footer__item"><a href="#" class="footer__link-item">微信号：mymicrowings</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Fall. Built with Docusaurus.</div></div></div></footer></div>
<script src="/my-website/assets/js/runtime~main.0db5d409.js"></script>
<script src="/my-website/assets/js/main.201f75f3.js"></script>
</body>
</html>